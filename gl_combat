function cargarDatosCombate(id, tipoCombate) {
    // Crear ventana modal de carga si no existe
    let loadingModal = document.getElementById('modalCargando');
    if (!loadingModal) {
        loadingModal = document.createElement('div');
        loadingModal.id = 'modalCargando';
        loadingModal.style.position = 'fixed';
        loadingModal.style.top = '0';
        loadingModal.style.left = '0';
        loadingModal.style.width = '100vw';
        loadingModal.style.height = '100vh';
        loadingModal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        loadingModal.style.display = 'flex';
        loadingModal.style.justifyContent = 'center';
        loadingModal.style.alignItems = 'center';
        loadingModal.style.zIndex = '100000';

        const content = document.createElement('div');
        content.style.backgroundColor = '#1f1f1f';
        content.style.padding = '30px';
        content.style.borderRadius = '14px';
        content.style.color = '#fff';
        content.style.textAlign = 'center';
        content.style.minWidth = '360px';
        content.style.maxHeight = '80vh';
        content.style.display = 'flex';
        content.style.flexDirection = 'column';
        content.style.gap = '20px';

        // Título
        const titulo = document.createElement('h2');
        titulo.textContent = 'Cargando datos...';
        content.appendChild(titulo);

        // GIF cargando
        const gif = document.createElement('img');
        gif.src = 'https://i.imgur.com/llF5iyg.gif';
        gif.alt = 'Cargando';
        gif.style.width = '60px';
        gif.style.height = '60px';
        content.appendChild(gif);

        // Contenedor de resultados (inicialmente oculto)
        const resultadosCont = document.createElement('div');
        resultadosCont.style.flex = '1';
        resultadosCont.style.overflowY = 'auto';
        resultadosCont.style.backgroundColor = '#2a2a2a';
        resultadosCont.style.borderRadius = '10px';
        resultadosCont.style.padding = '15px';
        resultadosCont.style.display = 'none';
        resultadosCont.style.textAlign = 'left';
        resultadosCont.style.fontFamily = 'monospace';
        resultadosCont.style.fontSize = '16px';
        content.appendChild(resultadosCont);

        // Botón cerrar (oculto al principio)
        const btnCerrar = document.createElement('button');
        btnCerrar.textContent = 'Cerrar';
        btnCerrar.style.backgroundColor = '#d33';
        btnCerrar.style.color = '#fff';
        btnCerrar.style.border = 'none';
        btnCerrar.style.padding = '10px 25px';
        btnCerrar.style.fontSize = '16px';
        btnCerrar.style.borderRadius = '12px';
        btnCerrar.style.cursor = 'pointer';
        btnCerrar.style.alignSelf = 'center';
        btnCerrar.style.display = 'none';
        btnCerrar.addEventListener('click', () => {
            loadingModal.style.display = 'none';
        });
        content.appendChild(btnCerrar);

        loadingModal.appendChild(content);
        document.body.appendChild(loadingModal);

        // Guardar referencias para usarlas más tarde
        loadingModal._refs = {
            titulo,
            gif,
            resultadosCont,
            btnCerrar,
        };
    } else {
        loadingModal.style.display = 'flex';
    }

    const refs = loadingModal._refs;

    // Reiniciar estado modal
    refs.titulo.textContent = 'Cargando datos...';
    refs.gif.style.display = 'block';
    refs.resultadosCont.style.display = 'none';
    refs.btnCerrar.style.display = 'none';
    refs.resultadosCont.textContent = '';

    const baseUrl = 'https://s55-es.gladiatus.gameforge.com/admin/index.php?action=module&modName=CombatLog&mode=showUser';
    let offset = 0;
    const tiempos = [];

    function cargarPagina() {
        const url = `${baseUrl}&user_id=${id}&cType=${tipoCombate}&offset=${offset}`;
        fetch(url, { credentials: 'include' })
            .then(resp => resp.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const tabla = doc.querySelector('table');

                if (!tabla || !tabla.querySelector('th')) {
                    // No más datos, mostrar resultados
                    mostrarResultados();
                    return;
                }

                const ths = tabla.querySelectorAll('th');
                ths.forEach(th => {
                    const horaNode = th.nextElementSibling;
                    if (horaNode && horaNode.textContent.trim().match(/\d{2}:\d{2}/)) {
                        tiempos.push(horaNode.textContent.trim());
                    }
                });

                offset += 30;
                setTimeout(cargarPagina, 500); // pequeña pausa para no saturar servidor
            })
            .catch(err => {
                console.error('Error cargando offset:', offset, err);
                mostrarResultados();
            });
    }

    function mostrarResultados() {
        refs.titulo.textContent = `Horas encontradas (${tiempos.length}):`;
        refs.gif.style.display = 'none';
        refs.resultadosCont.style.display = 'block';
        refs.btnCerrar.style.display = 'inline-block';

        if (tiempos.length === 0) {
            refs.resultadosCont.textContent = 'No se encontraron horas.';
            return;
        }

        refs.resultadosCont.textContent = tiempos.join('\n');
    }

    cargarPagina();
}
